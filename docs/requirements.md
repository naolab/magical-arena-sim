# magical-arena-sim 要件定義（v0.1）

## プロジェクト概要
- 仮想ライブバトル「magical-arena」のバトルシステムをブラウザ上で試遊可能なシミュレータとして実装する。
- バトルルールの調整と観客システムの検証を目的とし、友人やチームメンバーが手軽にプレイできる環境を提供する。
- 公開は GitHub Pages 等の静的ホスティングを想定し、更新頻度の高いパラメータ調整に素早く追従できることを重視する。

## ステークホルダー
- **デザイナー / プランナー**: バトルバランス検証・調整、数値変更の効果確認。
- **プレイヤー（友人含む）**: 簡単にプレイしてフィードバックを提供。
- **開発者**: バトルロジックの実装・継続的な改善、UI 改修対応。

## ゴール
1. バトル仕様（docs/battle-system-spec.md）に沿ったシミュレータの提供。
2. 1 バトルを 5〜8 ターンで決着できるスムーズなプレイ体験の実現。
3. GitHub Pages へビルド成果物を配置するだけで公開・更新できる開発フローの構築。
4. ルール調整に伴う数値や演出の変更を、数時間以内に反映できるスピード感を確保。

## ユースケース / シナリオ
- プレイヤーがブラウザでバトル開始 → 各ターンでアタック/アピール/ガードを選択 → 観客指示に応じて結果が変動 → 勝敗とログを確認。
- プランナーが数値パラメータ（ファン増減、アンチ閾値など）を変更 → シミュレーションで影響を確認。
- アンチゲージが高まった状態でファン獲得・火力ペナルティがどう効くかを検証。

## 機能要件（Functional Requirements）
1. バトル開始・終了とリセット操作を提供する。
2. 3 つの行動（アタック/アピール/ガード）をターンごとに選択可能。
3. 観客指示のランダム生成と表示（確率: 攻撃 40%、アピール 30%、ガードするな 30%）。
4. 三すくみ判定と勝敗結果（勝利/引き分け/敗北）の算出。
5. ダメージ計算、ファン率更新、アンチゲージ更新を仕様書に沿って実行。
6. アンチゲージ Lv に応じたファン獲得・火力ペナルティを再現。
7. バトルログ（ターンごとの行動・ダメージ・ファン/アンチ推移）表示。
8. 調整用パラメータを JSON 等で管理し、UI から簡易的に変更・再反映できる仕組みを提供。
9. 最終結果（HP・ファン率・アンチゲージ）を明示。

## 非機能要件（Non-Functional Requirements）
- **パフォーマンス**: 主要操作が 1 秒以内に応答し、1 バトルで体感ラグを感じさせない。
- **可搬性**: `npm install` → `npm run dev` / `npm run build` で動作。Node.js 18+ を前提。
- **アクセシビリティ**: キーボード操作でターン進行ができること、色覚多様性に配慮した配色を検討。
- **可読性**: TypeScript による型定義、テストで主要計算ロジックの正当性を担保。
- **デプロイ性**: `next build && next export` で静的サイト出力を生成し、GitHub Pages へデプロイ可能。

## 技術選定
- **フレームワーク**: Next.js (App Router)。静的エクスポート (`output: 'export'`) 前提で利用。
- **言語**: TypeScript + React。
- **スタイリング**: Tailwind CSS を第一候補（コンポーネントベースで UI 調整がしやすい）。場合によっては shadcn/ui 等を追加検討。
- **状態管理**: 初期は React Hooks (`useState`, `useReducer`) で十分。拡張時に Zustand または Jotai を検討。
- **ビルド / テスト**: Next.js 標準のテストテンプレートに Vitest + Testing Library もしくは Jest + RTL を追加。
- **lint/format**: ESLint, Prettier を導入し、型チェックは `tsc --noEmit`。

## アーキテクチャ概要
- `app/` 配下でページと API ルーティングを管理（静的サイト想定のため `app/api` は当面不使用）。
- コアロジックは `/src/lib/battle` などの純粋関数として実装し、UI と分離。
- 観客指示やアンチゲージなどの状態は、ターンごとのステートマシンで管理。
- 設定値は `/src/config/battleParams.ts` のような型付き定数として定義。将来的に JSON 読み込みや UI 設定画面を追加。

## デプロイフロー（予定）
1. `npm run build`（Next.js ビルド）→ `npm run export`（`out/` 生成）。
2. `out/` を GitHub Pages 用ブランチに push する、または GitHub Actions で自動化。
3. `main` ブランチ更新で CI がビルドと静的出力を行い、Pages に反映。

## リスク・課題
- 静的エクスポートではサーバーサイド処理ができないため、シミュレーションは完全にクライアントサイドで完結させる必要がある。
- 観客指示や乱数処理が再現性を損なわないよう、将来的にシード管理を検討。
- ブーイング演出など UI 演出の作り込み次第で CSS/JS の複雑度が増す可能性がある。

## 今後の検討事項
- 保存機能（プレイログやパラメータプリセット）の要否。
- マルチバトル・複数キャラクターの拡張計画。
- シミュレーションの自動実行（AI 対戦・バッチシミュレーション）への発展。
- シェア機能（生成したログをリンクで共有）。
